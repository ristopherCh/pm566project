---
title: "pm566midtermCDC"
author: "Chris Hanson"
date: "10/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(httr)
library(xml2)
library(data.table)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(dtplyr)
library(rvest)
```

```{r API-census-population}
# https://www.census.gov/data/developers/guidance/api-user-guide.Example_API_Queries.html
# Retrieving dimensions

censusquery <- GET(
  url = "https://api.census.gov/data/2019/pep/population?get=NAME,POP&for=state:*"
)

# Checking if the website is active
censusquery$status_code

# Processing data
census_content <- content(censusquery)

census <- rbindlist(census_content)
census <- census[order(V3)]
setnames(census, "V2", "population")
setnames(census, "V1", "state_name")
setnames(census, "V3", "state_number")

#Getting state abbreviations, frustratingly
abbrev <- read_html(x = "https://npiregistry.cms.hhs.gov/registry/API-State-Abbr")
abtable <- xml_find_all(abbrev, xpath = "/html/body/div[2]/div[2]/div/div/div/div[2]/div[2]/div[1]/table")
abtable <- html_table(abtable)
abtable <- rbindlist(abtable)
setnames(abtable, "State  Name", "state_name")
setnames(abtable, "State Abbreviation", "state_abbreviation")

#Combining census and abtable data.tables
census$state_name = toupper(census$state_name)
census <- merge(census, abtable)
```

```{r }
# Retrieving dimensions
# https://data.cdc.gov/NCHS/VSRR-Provisional-Drug-Overdose-Death-Counts/xkb8-kh2a

drugsquery <- GET(url = "https://data.cdc.gov/resource/xkb8-kh2a.json?$limit=50000")

# Checking if the website is active
drugsquery$status_code

# Processing data
drugs_content <- content(drugsquery)

# Turning the list into a data.table
drugs <- rbindlist(drugs_content[1:length(drugs_content)], fill=TRUE)
drugs$state_name = toupper(drugs$state_name)
```

```{r cdc_drugs-processing}
# Let's get a proper date time value!
drugs$date <- as.Date(paste0(drugs$year, drugs$month, "01"), format="%Y%B%d")
drugs$data_value <- as.numeric(drugs$data_value)
# Combining drugs and census data
#Merging population into drugs
drugs <- merge(drugs, census, by.x = "state_name", by.y = "state_name")
```


```{r}
# Making a data.table of just "Number of Drug Overdose Deaths"
od_deaths <- drugs[indicator == "Number of Drug Overdose Deaths"]
setnames(od_deaths, "data_value", "deaths_monthly")

#Data without "Total USA," good for plotting------------------------------------
od_deaths2 <- od_deaths[state_name != "United States"]
ggplot(od_deaths2, aes(x = date, y = deaths_monthly, color = state_name)) +
  geom_line()+
  labs(title = "Deaths by overdose")

# Plotting just one state without creating a new data.table first---------------
ggplot(od_deaths[state_name == "ALABAMA"], aes(x = date, y = deaths_monthly)) +
  geom_line() +
  labs(title = "Montly OD deaths in Nebraska")
```


```{r increase-drugs-by-state}
# Increase from January 2015 to March 2021 (all available data)-----------------
# (This could be the Y axis of a number of interesting charts)
od_min <- od_deaths[ , .SD[which.min(date)], by = state_name]
od_max <- od_deaths[ , .SD[which.max(date)], by = state_name]
od_dif <- od_max$deaths_monthly - od_min$deaths_monthly
od_perc_inc <- od_dif / od_min$deaths_monthly
od_min$perc_inc <- od_perc_inc * 100
```

```{r covid-vs-time}
# Retrieving dimensions

covidquery <- GET(
  url = "https://data.cdc.gov/resource/9mfq-cb36.json?$limit=50000"
)

# Checking if the website is active
covidquery$status_code

# Processing data
covid_content <- content(covidquery)

covid <- rbindlist(covid_content[1:length(covid_content)], fill=TRUE)
covid$date <- as.Date(covid$submission_date)
covid$tot_death <- as.numeric(covid$tot_death)
```

```{r}
# let's just see covid in cali over time, for kicks
# tot_death is total death
covid_ca <- covid[state == "CA"]

ggplot(covid_ca, aes(x = date, y = tot_death)) +
  geom_line() +
  labs(title = "Total covid deaths in California")

```

```{r}
#Combining census and covid data.tables
covid <- merge(covid, census, by.x = "state", by.y = "state_abbreviation")
covid$population <- as.numeric(covid$population)

#Fantastic! Now finally, let's do total death / total population
covid$death_perc <- covid$tot_death / covid$population
```

```{r}
#Let's plot covid deaths by population percent----------------------------------
ggplot(covid, aes(x = date, y = death_perc, color = state_name)) +
  geom_line(show.legend = FALSE) 

# Quick and dirty plot of covid vs drug deaths----------------------------------

covid_latest <- covid[ , .SD[which.max(date)], by = state_name]
#Here it is, covid_latest$death_perc

covid_od <- merge(covid_latest, od_min, by.x = "state", by.y = "state") 
ggplot(covid_od, aes(x = perc_inc, y = death_perc)) +
  geom_point() +
  labs(title = "")
#I'd say the above was a failed experiment

```


```{r}
# Actually that went really well! That's the first year for every state. Let's loop over the 6 years.
od_deaths <- od_deaths[order(state_name, date)]
date1 <- od_deaths$date[3]
date1 <- ymd(date1)
date2 <- date1 + months(12)
myfunc2 <- function(x,y){od_deaths[od_deaths$date >= x & od_deaths$date < y]}
z <- c(12, 24, 36, 48, 60)
#p <- myfunc2(date1, date2)
yearly_deaths <- aggregate(p$deaths_monthly, by=list(State=p$state_name), FUN=sum)
for (val in z) {
  p <- myfunc2(date1 + months(val), date2 + months(val))
  pp <- aggregate(p$deaths_monthly, by=list(State=p$state_name), FUN=sum)
  yearly_deaths <- merge(yearly_deaths, pp, by.x = "State", by.y = "State")
}

setnames(yearly_deaths, "x.x", "March 01, 2016")
setnames(yearly_deaths, "x.y", "March 01, 2017")
setnames(yearly_deaths, "x.x", "March 01, 2018")
setnames(yearly_deaths, "x.y", "March 01, 2019")
setnames(yearly_deaths, "x.x", "March 01, 2020")
setnames(yearly_deaths, "x.y", "March 01, 2021")

View(yearly_deaths)

# Reshape yearly_deaths before plotting

yd_long <- pivot_longer(yearly_deaths, cols = starts_with('M'))
setnames(yd_long, "name", "date")
setnames(yd_long, "value", "yearly_deaths")
yd_long$date <- as.Date(yd_long$date, "%B %d, %Y")

# Normalizing values per state population
yd_long <- merge(yd_long, census, by.x = "State", by.y = "state_name")
yd_long$population <- as.numeric(yd_long$population)
yd_long$norm_deaths <- yd_long$yearly_deaths / yd_long$population

View(yd_long)

ggplot(yd_long, aes(x = date, y = norm_deaths, color = State)) +
  geom_line(show.legend = FALSE) +
  geom_point(show.legend = FALSE) +
  labs(title = "Yearly drug overdose deaths per state, normalized")
```


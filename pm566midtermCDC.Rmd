---
title: "PM 566 Midterm Project"
author: "Chris Hanson"
date: "10/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

# How has COVID-19 affected the US substance abuse crisis?

## Introduction:

Drug overdose deaths in the United States have been rising steadily since the turn of the century, but a significant increase in this trend has been observed since the mid-2010's. Public discourse around this tragedy led to cultural and political changes which appeared to have slowed the trend around 2018. Then, in March 2020, the COVID-19 pandemic led to an upheaval in nearly every aspect of daily life, resulting in drastic changes to the way we work, socialize, and interact with society at large. 

Such a fundamental change in the way we live our lives was a universally destabilizing experience. To slow the spread of the virus, most public places of congregation were shut down, leading to widespread loss of jobs and a crash of the economy. Those with job security soon found new ways to work through the pandemic, and those without it found themselves without a job and an income.

The category of person most likely to be debilitated by the COVID-19 pandemic correlates with the type of person most vulnerable to experiencing drug addiction. Substance abuse is associated with unemployment or underemployment, lack of work opportunities, social isolation, mental health issues, and homelessness. As COVID-19 has undeniably contributed to each of these factors, an investigation into the pandemic’s effect on the substance abuse crisis is warranted.


```{r libraries, include = FALSE}
library(httr)
library(xml2)
library(data.table)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(dtplyr)
library(rvest)
library(stringr)
```



```{r API-census-population}
# https://www.census.gov/data/developers/guidance/api-user-guide.Example_API_Queries.html
# Retrieving dimensions

censusquery <- GET(
  url = "https://api.census.gov/data/2019/pep/population?get=NAME,POP&for=state:*"
)

# Checking if the website is active
#censusquery$status_code

# Processing data
census_content <- content(censusquery)

census <- rbindlist(census_content)
census <- census[order(V3)]
setnames(census, "V2", "population")
setnames(census, "V1", "state_name")
setnames(census, "V3", "state_number")

#Getting state abbreviations, frustratingly
abbrev <- read_html(x = "https://npiregistry.cms.hhs.gov/registry/API-State-Abbr")
abtable <- xml_find_all(abbrev, xpath = "/html/body/div[2]/div[2]/div/div/div/div[2]/div[2]/div[1]/table")
abtable <- html_table(abtable)
abtable <- rbindlist(abtable)
setnames(abtable, "State  Name", "state_name")
setnames(abtable, "State Abbreviation", "state_abbreviation")

#Combining census and abtable data.tables
census$state_name = toupper(census$state_name)
census <- merge(census, abtable)
#census$population <- as.numeric(census$population)
```

## Preliminary Results: 

COVID-19 was first detected in the USA on January 17, 2020, in Washington state. By March 13, 2020, President Trump had declared a nationwide emergency, and 2 days later, schools and restaurants began to shut down. By May 9th, 2020, the unemployment rate hit 14.7%, the worst rate since the Great Depression. By September 2020, the US COVID-19 death toll surpassed 200,000, and by January 18, 2021, it had doubled to 400,000. On December 14th, 2020, the initial phase of the vaccination program began, and by March 13, 2021, the US had surpassed 100 million vaccinations administered. By July 1st, 20201, the delta variant had become detected in all 50 US states.

This timeline helps provide a framework for interpreting the following simple plots:


```{r COVID}
# COVID DATA--------------------------------------------------------------------
```

```{r covid-vs-time}
# Retrieving dimensions

covidquery <- GET(
  url = "https://data.cdc.gov/resource/9mfq-cb36.json?$limit=50000"
)

# Checking if the website is active
#covidquery$status_code

# Processing data
covid_content <- content(covidquery)

covid <- rbindlist(covid_content[1:length(covid_content)], fill=TRUE)
covid$date <- as.Date(covid$submission_date)
covid$tot_death <- as.numeric(covid$tot_death)
covid$tot_cases <- as.numeric(covid$tot_cases)
covid$new_case <- as.numeric(covid$new_case)
covid$new_death <- as.numeric(covid$new_death)

# Removing extraneous columns from 'covid'
covid <- covid[, .(state, tot_cases, new_case, tot_death, new_death, date)]
covid <- covid[order(state, date)]
```

```{r}
#Combining census and covid data.tables
covid <- merge(covid, census, by.x = "state", by.y = "state_abbreviation")
covid$population <- as.numeric(covid$population)

# Creating death_perc, total death / total population
covid$death_perc <- covid$tot_death / covid$population
covid$case_perc <- covid$tot_cases / covid$population
covid$newdeath_perc <- covid$new_death / covid$population
covid$newcase_perc <- covid$new_case / covid$population
```

```{r covid_cali}
# let's just see covid in cali over time, for kicks
#covid_ca <- covid[state == "CA"]

#ggplot(covid_ca, aes(x = date, y = tot_death)) +
#  geom_line() +
#  labs(title = "Total covid deaths in California")

```

```{r}
# Summing up COVID data from all states, for total US values--------------------
covid_usa <- aggregate(cbind(tot_cases, new_case, tot_death, new_death, population) ~ date, data = covid, FUN = sum, na.rm = TRUE)
covid_usa$death_perc <- covid_usa$tot_death * 100 / covid_usa$population
covid_usa$death_cases <- covid_usa$new_death / covid_usa$new_case

ggplot(covid_usa, aes(x = date, y = new_case)) +
  geom_line() +
  labs(title = "New US COVID-19 cases") +
  geom_vline(xintercept=as.numeric(covid_usa$date[52]), linetype="dashed", size = 1) +
  annotate(geom = "text", x = covid_usa$date[60], y = 150000, label = "Emergency Declaration", angle = 90, color = "blue") +
  geom_vline(xintercept=as.numeric(covid_usa$date[109]), linetype="dashed", size = 1) +
  annotate(geom = "text", x = covid_usa$date[117], y = 150000, label = "14.7% unemployment", angle = 90, color = "blue") +
  geom_vline(xintercept=as.numeric(covid_usa$date[416]), linetype="dashed", size = 1) +
  annotate(geom = "text", x = covid_usa$date[424], y = 150000, label = "100 million vaccinations", angle = 90, color = "blue")+
  geom_vline(xintercept=as.numeric(covid_usa$date[329]), linetype="dashed", size = 1) +
  annotate(geom = "text", x = covid_usa$date[337], y = 60000, label = "Vaccination begins", angle = 90, color = "blue") +
  geom_vline(xintercept=as.numeric(covid_usa$date[527]), linetype="dashed", size = 1) +
  annotate(geom = "text", x = covid_usa$date[535], y = 150000, label = "Delta variant spreads", angle = 90, color = "blue") +
  xlab("Date") + ylab("New COVID-19 cases")

ggplot(covid_usa, aes(x = date, y = tot_cases)) +
  geom_line() +
  labs(title = "Total US COVID-19 cases")  +
  xlab("Date") + ylab("COVID-19 cases")

ggplot(covid_usa, aes(x = date, y = new_death)) +
  geom_line() +
  labs(title = "New US COVID-19 deaths") +
  xlab("Date") + ylab("Daily COVID-19 deaths")

ggplot(covid_usa, aes(x = date, y = tot_death)) +
  geom_line() +
  labs(title = "Total US COVID-19 deaths") +
  xlab("Date") + ylab("COVID-19 deaths")

ggplot(covid_usa, aes(x = date, y = death_perc)) +
  geom_line() +
  labs(title = "Total US COVID-19 deaths by % of US population") +
  xlab("Date") + ylab("Percent of US population")

ggplot(covid_usa, aes(x = date, y = death_cases)) +
  geom_line() +
  labs(title = "Ratio of new deaths to new cases in all US")


```


```{r}
# Ploting covid deaths by population percent----------------------------------
ggplot(covid, aes(x = date, y = case_perc, color = state_name)) +
  geom_line() +
  labs(title = "COVID-19 cases by % of state population") +
  xlab("Date") + ylab("COVID-19 cases") +
  theme(legend.title = element_text(size = 5), legend.text = element_text(size = 5))

#ggplot(covid, aes(x = date, y = newcase_perc, color = state_name)) +
#  geom_line(show.legend = FALSE) +
#  labs(title = "New COVID-19 cases by % of state population") +
#  xlab("Date") + ylab("Daily COVID-19 cases")

ggplot(covid, aes(x = date, y = death_perc, color = state_name)) +
  geom_line(show.legend = FALSE) +
  labs(title = "COVID-19 deaths by % of state population")+
  xlab("Date") + ylab("COVID-19 deaths")

#ggplot(covid, aes(x = date, y = newdeath_perc, color = state_name)) +
#  geom_line(show.legend = FALSE) +
#  labs(title = "New COVID-19 deaths by % of state population")+
#  xlab("Date") + ylab("Daily COVID-19 deaths") 
```

Having this information in hand will help provide perspective as a preliminary investigation into US drug useage patterns is explored.

```{r load-drugs}
# Retrieving dimensions
# https://data.cdc.gov/NCHS/VSRR-Provisional-Drug-Overdose-Death-Counts/xkb8-kh2a

drugsquery <- GET(url = "https://data.cdc.gov/resource/xkb8-kh2a.json?$limit=50000")

# Checking if the website is active
#drugsquery$status_code

# Processing data
drugs_content <- content(drugsquery)

# Turning the list into a data.table
drugs <- rbindlist(drugs_content[1:length(drugs_content)], fill=TRUE)
drugs$state_name = toupper(drugs$state_name)
```

```{r cdc_drugs-processing}
# Cleaning up the drugs data.table----------------------------------------------

drugs$date <- as.Date(paste0(drugs$year, drugs$month, "01"), format="%Y%B%d")

setnames(drugs, "data_value", "deaths")

drugs$deaths <- as.numeric(drugs$deaths)

# Combining drugs and census data
drugs <- merge(drugs, census, by.x = "state_name", by.y = "state_name")
drugs$population <- as.numeric(drugs$population)

# Removing extraneous columns from 'drugs'
drugs <- drugs[, .(state_name, state, indicator, deaths, date, population, state_number)]

# Cleaning up drugs$indicator column
drugs$indicator <- gsub("\\([^()]*\\)", "", drugs$indicator)
drugs$indicator <- str_trim(drugs$indicator, side = c("both"))
drugs <- drugs[indicator != "Percent with drugs specified"]


# Making a deaths per population column
drugs$deathspop <- drugs$deaths *100 / drugs$population
```

The CDC provides a vast and thorough dataset giving monthly summaries of overdose deaths, by state, categorized by drug type (heroin, cocaine, opioids, etc.) as well as drug type subcategories (synthetic opioids, natural & semi-synthetic opioids, etc). 

```{r drugs_usa}
# Summing up drug deaths in all states for a total US value---------------------
drugs_usa <- drugs[, sum(deaths, na.rm = TRUE), by=list(indicator, date)]
setnames(drugs_usa, "V1", "deaths")
drugs_usa <- drugs_usa[order(date, indicator)]

drugs_usa2 <- drugs_usa[indicator != c("Number of Deaths")]

ggplot(drugs_usa2, aes(x = date, y = deaths, color = indicator)) +
  geom_line() +
  theme(legend.title = element_text(size = 8), legend.text = element_text(size = 7))

# Creating drugs_usa2 for plotting


```

(First, it must be mentioned that all data regarding specific drug types is unavailable for the years of 2016 and 2017. I'm hoping to rectify this soon.)

This is a graph of overdoses in the US, broken down by drug type and subtype. Some of these are independent of all others: Psychostimulants (including methamphedamine) and cocaine have their own categories. Others share data: there is one category for all opioids, another for natural opioids, and another for synthetic opioids. As some categories are relatively low in number and unchanging over time, these categories can be narrowed down for clarity:

```{r}
drugs_usa2 <- drugs_usa2[indicator != c("Number of Drug Overdose Deaths")]
drugs_usa2 <- drugs_usa2[indicator != c("Natural & semi-synthetic opioids, incl. methadone")]
drugs_usa2 <- drugs_usa2[indicator != c("Natural & semi-synthetic opioids")]
drugs_usa2 <- drugs_usa2[indicator != c("Natural, semi-synthetic, & synthetic opioids, incl. methadone")]
drugs_usa2 <- drugs_usa2[indicator != c("Cocaine")]
drugs_usa2 <- drugs_usa2[indicator != c("Heroin")]
drugs_usa2 <- drugs_usa2[indicator != c("Methadone")]
# 
ggplot(drugs_usa2, aes(x = date, y = deaths, color = indicator)) +
  geom_line() +
  theme(legend.title = element_text(size = 8), legend.text = element_text(size = 7)) +
  geom_vline(xintercept=as.numeric(drugs_usa$date[685]), linetype="dashed", size = 1) +
  annotate(geom = "text", x = drugs_usa$date[650], y = 15000, label = "Start of COVID-19", angle = 90)
```

This graph immediately suggests some insights. For one, there does appear to be a clear acceleration in the rate of drug overdose deaths following the onset of the COVID-19 pandemic. Another is regarding the types of drugs involved: While opioids are by far the most implicated drug, it is the synthetic, not the natural, opioids that are the primary driver. Natural opioids are those such as morphine and codeine, which are popularly recognized. A common semi-synthetic opioid is heroin. 

However, the synthetic opioid behind this great increase is fentanyl, which is often illicitly manufactured and commonly used to lace other drugs. There has been considerable coverage of the rise of fentanyl and the damage it is causing the US.

```{r}
# Making a plot that cuts out all of the missing 2016/2017 data.
drugs_usa_2018 <- drugs_usa[date > "2017-12-01"]
drugs_usa2_2018 <- drugs_usa_2018[indicator != c("Number of Deaths", "Number of Drug Overdose Deaths")]
#drugs_usa2_2018 <- drugs_usa2_2018[indicator != "Percent with drugs specified"]

ggplot(drugs_usa2_2018, aes(x = date, y = deaths, color = indicator)) +
  geom_line()
indicators = unique(drugs$indicator)
indicators3 <- c(indicators[2],indicators[6],indicators[8])
drugs_usa3_2018 <- drugs_usa_2018[indicator %in% indicators3]

ggplot(drugs_usa3_2018, aes(x = date, y = deaths, color = indicator)) +
  geom_line(size = 1) +
  geom_vline(xintercept=as.numeric(drugs_usa3_2018$date[80]), linetype="dashed", size = 1) +
  annotate(x = drugs_usa3_2018$date[82], y = 59000, label = "Start of COVID-19", geom="text", angle = 90) +
  labs(x = "Date", y = "Deaths", title = "Words") +
  scale_x_date(date_breaks = "6 month", date_minor_breaks = "1 month", date_labels = "%b-%y") +
  theme(legend.title = element_text(size = 8), legend.text = element_text(size = 7))

maxod <- drugs_usa[date == "2021-03-01" & indicator == "Number of Drug Overdose Deaths"]
maxsynth <- drugs_usa[date == "2021-03-01" & indicator == "Synthetic opioids, excl. methadone"]
```

On March 01, 2021 - the most recent data provided in this dataset - synthetic opioids were responsible for `r maxsynth[[3]] * 100 / maxod[[3]]`% of all drug overdose deaths in the US.

```{r od_deaths}
# Making a data.table of just "Number of Drug Overdose Deaths"------------------

od_deaths <- drugs[indicator == "Number of Drug Overdose Deaths"]
od_deaths <- od_deaths[order(state_name, date)]

# Plot of all drug overdoses for every state, total number
ggplot(od_deaths, aes(x = date, y = deaths, color = state_name)) +
  geom_line() +
  labs(title = "Monthly deaths by overdose") +
  theme(legend.title = element_text(size = 5), legend.text = element_text(size = 5))

# Plotting just one state without creating a new data.table first---------------
ggplot(od_deaths[state_name == "ALABAMA"], aes(x = date, y = deaths)) +
  geom_line() +
  labs(title = "Montly OD deaths in one state")

# Plotting od deaths scaled by population
ggplot(od_deaths, aes(x = date, y = deathspop, color = state_name)) +
  geom_line(show.legend = FALSE) +
  labs(title = "Monthly deaths by overdose, by % of state pop")

# Out of curiosity, getting a sum of deathspop per state]
od_deaths_sum <- od_deaths[, sum(deathspop, na.rm = TRUE), by = state]
od_deaths_sum <- od_deaths_sum[order(-V1)]
```


```{r increase-drugs-by-state}
# Increase from January 2015 to March 2021 (all available data)-----------------
od_min <- od_deaths[ , .SD[which.min(date)], by = state_name]
od_max <- od_deaths[ , .SD[which.max(date)], by = state_name]
od_dif <- od_max$deaths - od_min$deaths
od_perc_inc <- od_dif / od_min$deaths
od_min$perc_inc <- od_perc_inc * 100

# This is the % increase in OD deaths from January 2015 to March 2021 per state-
od_perc_incr <- od_min[, .(state_name, state, indicator, perc_inc)]

# This is the % increase in OD deaths from March 2020 to March 2021 per state-
od_0320 <- od_deaths[date == "2020-03-01"]
od_dif0320 <- (od_max$deaths - od_0320$deaths) * 100 / od_0320$deaths
od_0320$perc_inc <- od_dif0320
od_perc_incr0320 <- od_0320[, .(state_name, state, indicator, perc_inc)]

# This is how to get a range of values by date. Wow, easy.
#od_range <- od_deaths[date > "2018-01-01" & date < "2020-01-01"]

```

---------------------

```{r}
# Playing with plots of covid vs drug deaths----------------------------------
covid_latest <- covid[ , .SD[which.max(date)], by = state_name]
covid_0321 <- covid[date == "2021-03-01"]

covid_od <- merge(covid_latest, od_perc_incr, by.x = "state", by.y = "state")
covid_od0320 <- merge(covid_0321, od_perc_incr0320, by.x = "state", by.y = "state")

ggplot(covid_od0320, aes(y = perc_inc, x = case_perc)) +
  geom_point() +
  geom_smooth() +
  labs(title = "")
```


```{r}
# 2015-03-01
date1 <- od_deaths$date[3]
date1 <- ymd(date1)
# 2016-03-01
date2 <- date1 + months(12)

# Creates a DT of data between two dates given
myfunc2 <- function(x,y){od_deaths[od_deaths$date >= x & od_deaths$date < y]}
p <- myfunc2(date1, date2)

# Sum up deaths between the two dates (March 2015-2016 here) by state. 
yearly_deaths <- aggregate(p$deaths, by=list(State=p$state_name), FUN=sum)

# Now again, for the next 5 years. One by one, merge these vectors together.
z <- c(12, 24, 36, 48, 60)
for (val in z) {
  p <- myfunc2(date1 + months(val), date2 + months(val))
  pp <- aggregate(p$deaths, by=list(State=p$state_name), FUN=sum)
  yearly_deaths <- merge(yearly_deaths, pp, by.x = "State", by.y = "State")
}

#Column titles came out weird, fixing them:
setnames(yearly_deaths, "x.x", "March 01, 2016")
setnames(yearly_deaths, "x.y", "March 01, 2017")
setnames(yearly_deaths, "x.x", "March 01, 2018")
setnames(yearly_deaths, "x.y", "March 01, 2019")
setnames(yearly_deaths, "x.x", "March 01, 2020")
setnames(yearly_deaths, "x.y", "March 01, 2021")

# Reshape yearly_deaths before plotting

yd_long <- pivot_longer(yearly_deaths, cols = starts_with('M'))
setnames(yd_long, "name", "date")
setnames(yd_long, "value", "yearly_deaths")
yd_long$date <- as.Date(yd_long$date, "%B %d, %Y")

# Normalizing values per state population
yd_long <- merge(yd_long, census, by.x = "State", by.y = "state_name")
yd_long$population <- as.numeric(yd_long$population)
yd_long$norm_deaths <- yd_long$yearly_deaths / yd_long$population

ggplot(yd_long, aes(x = date, y = norm_deaths, color = State)) +
  geom_line(show.legend = FALSE) +
  geom_point(show.legend = FALSE) +
  labs(title = "Yearly drug overdose deaths per state, normalized")
```


---
title: "pm566midtermCDC"
author: "Chris Hanson"
date: "10/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(httr)
library(xml2)
library(data.table)
# library(lubridate)
library(ggplot2)
library(tidyverse)
library(dtplyr)
library(rvest)
```

```{r }
# Retrieving dimensions
# https://data.cdc.gov/NCHS/VSRR-Provisional-Drug-Overdose-Death-Counts/xkb8-kh2a

cdcdrugsquery <- GET(
  url = "https://data.cdc.gov/resource/xkb8-kh2a.json?$limit=50000"
)

#https://data.cdc.gov/resource/xkb8-kh2a.json?$limit=50000

# Checking if the website is active
cdcdrugsquery$status_code

# Processing data
cdc_drugs_content <- content(cdcdrugsquery)

# The data is in the second element of the "dimensions" list.
# This really makes a nice data frame.
#cdc2 <- do.call(rbind, cdc[1])

cdc_drugs <- rbindlist(cdc_drugs_content[1:length(cdc_drugs_content)], fill=TRUE)
# dimensions <- rbindlist(dimensions[[2]]) #equivalently
```

```{r cdc_drugs-processing}
# Let's get a proper date time value!
#cdc_drugs$date <- format(as.Date(paste0(cdc_drugs$year, cdc_drugs$month, "01"), format="%Y%B%d"), "%Y-%m")

cdc_drugs$date <- as.Date(paste0(cdc_drugs$year, cdc_drugs$month, "01"), format="%Y%B%d")
cdc_drugs$data_value <- as.numeric(cdc_drugs$data_value)
```


```{r}
# This is a good consistent indicator
cdc_od_deaths <- cdc_drugs[indicator == "Number of Drug Overdose Deaths"]
cdc_od_cali <- cdc_od_deaths[state_name == "California"]


cdc_od_deaths2 <- cdc_od_deaths[state_name != "United States"]
ggplot(cdc_od_deaths2, aes(x = date, y = data_value, color = state_name)) +
  geom_line()+
  labs(title = "Deaths by overdose")


ggplot(cdc_od_deaths[state_name == "Nebraska"], aes(x = date, y = data_value)) +
  geom_line() 
```


```{r increase-drugs-by-state}
# Increase from January 2015 to March 2021
# This is the Y axis of a number of interesting charts
od_min <- cdc_od_deaths[ , .SD[which.min(date)], by = state_name]
od_max <- cdc_od_deaths[ , .SD[which.max(date)], by = state_name]
od_dif <- od_max$data_value - od_min$data_value
od_perc_inc <- od_dif / od_min$data_value
od_min$inc <- od_perc_inc

head(od_min)
```

```{r covid-vs-time}
# Retrieving dimensions

covidquery <- GET(
  url = "https://data.cdc.gov/resource/9mfq-cb36.json?$limit=50000"
)

# Checking if the website is active
covidquery$status_code

# Processing data
covid_content <- content(covidquery)

covid <- rbindlist(covid_content[1:length(covid_content)], fill=TRUE)
```

```{r}
# let's just see covid in cali over time, for kicks
# tot_death is total death
ca_covid <- covid[state == "CA"]

ca_covid$date <- as.Date(ca_covid$submission_date)
ca_covid$tot_death <- as.numeric(ca_covid$tot_death)

ggplot(ca_covid, aes(x = date, y = tot_death)) +
  geom_line() +
  labs(title = "Total covid deaths in California")

```

```{r API-census-population}
# https://www.census.gov/data/developers/guidance/api-user-guide.Example_API_Queries.html
# Retrieving dimensions

censusquery <- GET(
  url = "https://api.census.gov/data/2019/pep/population?get=NAME,POP&for=state:*"
)

# Checking if the website is active
censusquery$status_code

# Processing data
census_content <- content(censusquery)

census <- rbindlist(census_content)
census <- census[order(V3)]

#Getting state abbreviations, frustratingly
abbrev <- read_html(x = "https://npiregistry.cms.hhs.gov/registry/API-State-Abbr")
abtable <- xml_find_all(abbrev, xpath = "/html/body/div[2]/div[2]/div/div/div/div[2]/div[2]/div[1]/table")
abtable <- html_table(abtable)
abtable <- rbindlist(abtable)

#Combining census and abtable data.tables
census$V1 = toupper(census$V1)
census <- merge(census, abtable, by.x = "V1", by.y = "State  Name")

#Combining census and covid data.tables
covid2 <- merge(covid, census, by.x = "state", by.y = "State Abbreviation")
#Good, need to rename "V2" to "population"
```

